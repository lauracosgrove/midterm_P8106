---
title: "Stepwise and GAM"
author: "Alyssa Vanderbeek (amv2187)"
date: "3/31/2019"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(caret)
library(mgcv)
library(nlme)
library(MASS)
```

Data import 

```{r}
heart = readr::read_csv("data/train_imputed.csv") %>%
  mutate(pure_population = as.factor(pure_population),
         urban_influence = factor(urban_influence, labels = 1:12),
         economic_typology = as.factor(economic_typology),
         metro_adjacency = as.factor(metro_adjacency),
         metro = as.factor(metro)) %>% 
  dplyr::select(-row_id)

test = readr::read_csv("data/test_imputed.csv") %>% 
  mutate(pure_population = as.factor(pure_population),
         urban_influence = as.factor(urban_influence),
         economic_typology = as.factor(economic_typology),
         metro_adjacency = as.factor(metro_adjacency),
         metro = as.factor(metro)) %>% 
  dplyr::select(-row_id)

```

Stepwise model 

```{r}
# Stepwise model selection
set.seed(2)
step.fit = caret::train(heart_disease_mortality_per_100k ~ ., 
                        data = heart, 
                        method = 'glmStepAIC',
                        metric = 'RMSE',
                        trControl = trainControl(method = "repeatedcv", number = 10, repeats = 5))
summary(step.fit)


## predict on test data
# pred.step = predict.lm(step.fit, newdata = test)
# mean((pred.step - test$heart_disease_mortality_per_100k)^2) # MSE
```

GAM

```{r}
set.seed(2)
gam.fit <- caret::train(heart_disease_mortality_per_100k ~ ., 
                        data = heart,
                        method = "gam",
                        metric = 'RMSE',
                        tuneGrid = data.frame(method = "GCV.Cp", select = c(TRUE, FALSE)),
                        trControl = trainControl(method = "repeatedcv", number = 10, repeats = 5))


gam.fit$finalModel

## Predict on test data

pred.gam = mgcv::predict.gam(gam.fit, newdata = test)
mean((pred.gam - test$heart_disease_mortality_per_100k)^2) # MSE
```


```{r}
saveRDS(step.fit, 'lm_step_imputed.rds')
saveRDS(gam.fit, 'gam_fit_imputed.rds')
```



